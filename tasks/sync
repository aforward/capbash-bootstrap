#!/bin/bash
MODE=${1}
TARGET=${2} # the ip of the server
USER=${3-root}
GROUP=${4-$USER}

if [ -z "$MODE" ]; then
  echo "USAGE: capbash sync <mode> <Target IP/host> <user>"
  echo "   eg: capbash sync push my-server.localnet"
  exit 0
fi

AUTHORIZED_KEYS_FILENAME=./assets/${USER}_authorized_keys
if [ ! -f $AUTHORIZED_KEYS_FILENAME ]; then
  mkdir -p ./assets
  pubkey_file=$HOME/.ssh/id_dsa.pub
  if [ ! -f $pubkey_file ]; then
    echo "Please put your public key in $AUTHORIZED_KEYS_FILENAME file"
    exit 0
  else
    echo "Copying your public key ($pubkey_file) to $AUTHORIZED_KEYS_FILENAME"
    cp $pubkey_file $AUTHORIZED_KEYS_FILENAME
  fi
fi

echo "Uploading Authorized Keys For Bootstrap..."
ssh $USER@$TARGET 'mkdir -p ~/.ssh' > /dev/null
scp $AUTHORIZED_KEYS_FILENAME $USER@$TARGET:~/.ssh/authorized_keys > /dev/null

CAP_CALL="bundle exec cap capbash:$MODE TARGET=$TARGET NODE=default USER=$USER GROUP=$GROUP"
cd ./submodules/bootstrap
$CAP_CALL
